<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UMOJA V2 • Register / Login</title>

  <style>
    :root{
      --bg:#07181a;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text:#eaf6f5;
      --muted: rgba(234,246,245,.70);
      --accent:#2bd3b1;
      --accent2:#0bbf9a;
      --danger:#ff5d5d;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 50% 10%, rgba(43,211,177,.14), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(0,0,0,.65), rgba(0,0,0,.9)),
        linear-gradient(180deg, #0a2a2c, #061618);
      color:var(--text);
      padding:24px;
    }
    .wrap{width:min(460px, 100%);}
    .brand{
      text-align:center;
      margin-bottom:16px;
    }
    .logo{
      width:74px;height:74px;border-radius:50%;
      margin:0 auto 10px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 30%, rgba(43,211,177,.25), rgba(0,0,0,.55));
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .brand h1{
      margin:0;
      font-size:32px;
      letter-spacing:2px;
    }
    .brand p{margin:6px 0 0; color:var(--muted)}
    .card{
      margin-top:14px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:22px;
      padding:18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .tabs{
      display:flex;
      gap:10px;
      background: rgba(0,0,0,.18);
      padding:8px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
    }
    .tab{
      flex:1;
      padding:12px 10px;
      border-radius:14px;
      text-align:center;
      font-weight:700;
      cursor:pointer;
      color: rgba(234,246,245,.65);
      user-select:none;
    }
    .tab.active{
      background: rgba(43,211,177,.14);
      color: var(--text);
      border:1px solid rgba(43,211,177,.20);
    }
    .form{margin-top:14px;}
    .field{
      margin-top:12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px;
    }
    .field input{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size:18px;
      padding:8px 6px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      width:100%;
      margin-top:14px;
      border:none;
      border-radius:18px;
      padding:14px 14px;
      font-size:18px;
      font-weight:800;
      cursor:pointer;
      color:#06201e;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 25px rgba(43,211,177,.18);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .small{
      margin-top:10px;
      text-align:center;
      color: rgba(234,246,245,.70);
      font-size:14px;
      line-height:1.35;
    }
    .small a{color:var(--accent); text-decoration:none; font-weight:700}
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(234,246,245,.85);
      font-size:14px;
      display:none;
    }
    .msg.error{border-color: rgba(255,93,93,.35); color: #ffd6d6;}
    .inviteBox{
      margin-top:12px;
      border-radius:18px;
      padding:12px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      display:none;
    }
    .inviteBox .label{color:rgba(234,246,245,.65); font-size:13px}
    .inviteBox .code{
      margin-top:6px;
      font-size:20px;
      letter-spacing:2px;
      font-weight:800;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo">
        <!-- Optional: put your logo image inside -->
        <!-- <img src="logo.png" alt="UMOJA" style="width:100%;height:100%;object-fit:cover;"> -->
      </div>
      <h1>UMOJA V2</h1>
      <p>Official Landing • Verify • Invest • Invite</p>
    </div>

    <div class="card">
      <div class="tabs">
        <div id="tabRegister" class="tab active">Register</div>
        <div id="tabLogin" class="tab">Login</div>
      </div>

      <div class="form">
        <div class="field">
          <input id="emailOrPhone" type="text" placeholder="Email or Phone" autocomplete="username" />
        </div>

        <div class="field row">
          <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
          <button id="togglePw" type="button" style="border:none;background:rgba(255,255,255,.08);color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:700;">Show</button>
        </div>

        <button id="actionBtn" class="btn">Create Account</button>

        <div id="inviteBox" class="inviteBox">
          <div class="label">Referral detected from link:</div>
          <div id="inviteCode" class="code"></div>
        </div>

        <div id="msg" class="msg"></div>

        <div class="small">
          By continuing you agree to the <a href="#" onclick="alert('Add your Registration Agreement page/link here');return false;">Registration Agreement</a>.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
  // Firebase (Modular CDN)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  import {
    getFirestore,
    doc,
    setDoc,
    addDoc,
    collection,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ✅ REPLACE with your Firebase Console Web App config
  const firebaseConfig = {
    apiKey: "PASTE_YOURS",
    authDomain: "PASTE_YOURS",
    projectId: "PASTE_YOURS",
    storageBucket: "PASTE_YOURS",
    messagingSenderId: "PASTE_YOURS",
    appId: "PASTE_YOURS"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --------------------------
  // Referral capture + logging
  // --------------------------
  function getRefFromUrl() {
    const p = new URLSearchParams(window.location.search);
    return (p.get("ref") || "").trim() || null;
  }

  function getRefStored() {
    return localStorage.getItem("umoja_ref") || null;
  }

  function setRefStored(ref) {
    localStorage.setItem("umoja_ref", ref);
  }

  async function logInviteClick(ref) {
    // logs even before login
    await addDoc(collection(db, "inviteClicks"), {
      ref,
      page: window.location.pathname || "/",
      userAgent: navigator.userAgent,
      createdAt: serverTimestamp()
    });
  }

  (async function initReferral() {
    const ref = getRefFromUrl();
    if (ref) {
      setRefStored(ref);
      try { await logInviteClick(ref); } catch (e) { console.log("inviteClick log failed:", e); }
    }

    // OPTIONAL: show it in UI if you have an element with id="refDetected"
    const show = document.getElementById("refDetected");
    const finalRef = getRefStored();
    if (show && finalRef) show.textContent = finalRef;
  })();

  // --------------------------
  // Hook your existing UI
  // --------------------------
  // Update these IDs to match your HTML input/button IDs:
  const regEmailPhone = document.getElementById("regEmailPhone"); // input
  const regPassword   = document.getElementById("regPassword");   // input
  const regBtn        = document.getElementById("createAccountBtn"); // button

  const loginEmailPhone = document.getElementById("loginEmailPhone"); // input
  const loginPassword   = document.getElementById("loginPassword");   // input
  const loginBtn        = document.getElementById("loginBtn");        // button

  const statusBox = document.getElementById("statusBox"); // div for messages (optional)

  function msg(text, ok=false){
    if (!statusBox) return alert(text);
    statusBox.textContent = text;
    statusBox.style.opacity = "1";
    statusBox.style.borderColor = ok ? "rgba(60,220,140,.8)" : "rgba(255,90,90,.8)";
  }

  // --------------------------
  // Register (EMAIL only)
  // --------------------------
  // NOTE: Firebase Auth does NOT accept phone number like email unless you implement real Phone Auth (SMS).
  // So we do: if user types a phone, we store it in Firestore but Auth uses a generated email alias.
  function looksLikePhone(v){
    return /^[+0-9() \-]{7,}$/.test(v);
  }

  function normalizePhone(v){
    return v.replace(/[^\d+]/g,"");
  }

  function phoneToEmailAlias(phone){
    const p = normalizePhone(phone);
    return `${p}@phone.umoja.local`;
  }

  async function register(){
    const raw = (regEmailPhone?.value || "").trim();
    const pass = (regPassword?.value || "").trim();
    if (!raw || !pass) return msg("Enter email/phone + password");

    let authEmail = raw;
    let phone = null;
    let email = null;

    if (looksLikePhone(raw) && !raw.includes("@")) {
      phone = normalizePhone(raw);
      authEmail = phoneToEmailAlias(phone);
    } else {
      email = raw;
    }

    try {
      const cred = await createUserWithEmailAndPassword(auth, authEmail, pass);
      const user = cred.user;

      await setDoc(doc(db, "users", user.uid), {
        emailOrPhone: raw,
        email: email || null,
        phone: phone || null,
        referredBy: getRefStored(),
        createdAt: serverTimestamp()
      }, { merge: true });

      msg("Account created ✅", true);
    } catch (e) {
      msg(e?.message || String(e));
    }
  }

  // --------------------------
  // Login (same logic)
  // --------------------------
  async function login(){
    const raw = (loginEmailPhone?.value || "").trim();
    const pass = (loginPassword?.value || "").trim();
    if (!raw || !pass) return msg("Enter email/phone + password");

    let authEmail = raw;
    if (looksLikePhone(raw) && !raw.includes("@")) {
      authEmail = phoneToEmailAlias(raw);
    }

    try{
      await signInWithEmailAndPassword(auth, authEmail, pass);
      msg("Logged in ✅", true);
    }catch(e){
      msg(e?.message || String(e));
    }
  }

  regBtn?.addEventListener("click", register);
  loginBtn?.addEventListener("click", login);

  onAuthStateChanged(auth, (user)=>{
    // optional: show user state somewhere
    const el = document.getElementById("whoami");
    if (el) el.textContent = user ? user.uid : "not logged";
  });
</script>

</body>
</html>
